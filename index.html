```html
<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=no"/>
  <title>GBL Runner — Commit Zone (Stable, Paper-Ready)</title>
  <style>
    :root{
      --bg:#071025;
      --ink:#eaf0ff;
      --muted:#b9c6ff;

      --panel:rgba(255,255,255,.08);
      --border:rgba(255,255,255,.14);
      --shadow:0 12px 34px rgba(0,0,0,.35);

      --good:#39d98a;
      --bad:#ff5c7a;

      --a:#7c5cff;
      --b:#33d6ff;
      --c:#ff7ad9;
      --zone:#ffd84d;
    }
    *{box-sizing:border-box}
    body{
      margin:0; color:var(--ink);
      font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif;
      background:
        radial-gradient(1000px 450px at 70% 10%, rgba(100,181,255,.18), transparent 55%),
        radial-gradient(900px 420px at 20% 20%, rgba(124,92,255,.14), transparent 60%),
        var(--bg);
      overflow:hidden;
    }
    .wrap{height:100dvh; display:flex; flex-direction:column;}
    header{
      padding:12px 14px 10px;
      display:flex; gap:10px; justify-content:space-between; align-items:center; flex-wrap:wrap;
    }
    .brand{display:flex; flex-direction:column; gap:2px; min-width:280px;}
    .brand .t{font-weight:900;}
    .brand .s{font-size:12px; color:var(--muted)}
    .hud{display:flex; gap:10px; align-items:center; flex-wrap:wrap; justify-content:flex-end;}
    .pill{
      background:rgba(255,255,255,.06);
      border:1px solid rgba(255,255,255,.10);
      border-radius:999px;
      padding:8px 10px;
      box-shadow:var(--shadow);
      font-size:12px;
      display:flex; gap:8px; align-items:center;
      backdrop-filter: blur(8px);
      user-select:none;
    }
    .pill b{font-size:13px}
    .btn{
      border:1px solid rgba(255,255,255,.16);
      background:rgba(255,255,255,.08);
      color:var(--ink);
      border-radius:12px;
      padding:10px 12px;
      cursor:pointer;
      font-weight:850;
      box-shadow:var(--shadow);
      user-select:none;
      transition: transform .05s ease;
    }
    .btn:active{transform:translateY(1px)}

    main{flex:1; padding:0 12px 12px; display:flex; flex-direction:column; gap:10px;}
    .row{display:flex; gap:10px; align-items:stretch;}
    .card{
      background:linear-gradient(180deg, rgba(255,255,255,.09), rgba(255,255,255,.04));
      border:1px solid var(--border);
      border-radius:18px;
      box-shadow:var(--shadow);
      padding:12px;
      backdrop-filter: blur(10px);
    }
    .qCard{flex:1.2; min-height:160px; position:relative; overflow:hidden;}
    .qTitle{display:flex; justify-content:space-between; align-items:center; gap:8px; flex-wrap:wrap; margin-bottom:6px;}
    .badge{
      font-size:12px;
      padding:6px 10px;
      border-radius:999px;
      background:rgba(100,181,255,.16);
      border:1px solid rgba(100,181,255,.35);
      white-space:nowrap;
      user-select:none;
    }
    .qText{font-size:16px; line-height:1.28; font-weight:900; margin-top:6px;}
    .choices{margin-top:10px; display:grid; gap:6px;}
    .choice{
      display:flex; gap:10px; align-items:center;
      padding:9px 10px;
      border-radius:14px;
      border:1px solid rgba(255,255,255,.10);
      background:rgba(0,0,0,.10);
      font-size:13px;
      user-select:none;
    }
    .tag{
      width:30px; height:30px; border-radius:10px;
      display:grid; place-items:center;
      font-weight:950; color:#0b1220;
      flex:0 0 auto;
    }
    .tag.A{background:var(--a)}
    .tag.B{background:var(--b)}
    .tag.C{background:var(--c)}
    .muted{color:var(--muted)}

    /* Read pause bar */
    .readBarWrap{
      margin-top:10px;
      padding:10px;
      border-radius:14px;
      border:1px solid rgba(255,255,255,.12);
      background:rgba(0,0,0,.10);
      display:none;
    }
    .readLabel{
      display:flex; justify-content:space-between; align-items:center;
      font-size:12px; color:var(--muted); font-weight:750;
      margin-bottom:8px;
    }
    .bar{
      height:10px;
      border-radius:999px;
      background:rgba(255,255,255,.10);
      overflow:hidden;
      border:1px solid rgba(255,255,255,.10);
    }
    .bar > div{
      height:100%;
      width:0%;
      background:linear-gradient(90deg, rgba(51,214,255,.85), rgba(124,92,255,.85));
    }

    .statusLine{
      margin-top:10px;
      padding:10px;
      border-radius:14px;
      border:1px solid rgba(255,255,255,.12);
      background:rgba(0,0,0,.10);
      font-size:12px;
      color:var(--muted);
      display:none;
    }

    .gameCard{flex:1.8; display:flex; flex-direction:column; gap:10px; padding:10px;}
    canvas{
      width:100%;
      height:min(56dvh, 560px);
      border-radius:16px;
      border:1px solid rgba(255,255,255,.12);
      background:linear-gradient(180deg, rgba(255,255,255,.06), rgba(0,0,0,.12));
      box-shadow:var(--shadow);
      touch-action:none;
    }

    .controls{
      display:grid;
      grid-template-columns: 1fr 1fr 1fr;
      gap:10px;
      align-items:stretch;
    }
    .ctl{
      border-radius:16px;
      padding:14px 10px;
      border:1px solid rgba(255,255,255,.14);
      background:rgba(255,255,255,.08);
      box-shadow:var(--shadow);
      user-select:none;
      display:flex; flex-direction:column; gap:4px;
      align-items:center;
      font-weight:950;
      text-align:center;
      min-height:56px;
    }
    .ctl small{font-weight:700; color:var(--muted); line-height:1.2;}

    .footerRow{
      display:flex; gap:10px; flex-wrap:wrap;
      justify-content:space-between; align-items:center;
      padding:2px 2px 0;
    }
    .tiny{font-size:12px; color:var(--muted)}

    .pop{
      position:absolute;
      left:50%; top:56%;
      transform:translate(-50%,-50%);
      padding:12px 14px;
      border-radius:18px;
      font-weight:950;
      display:none;
      z-index:5;
      border:1px solid rgba(255,255,255,.14);
      box-shadow:var(--shadow);
      backdrop-filter: blur(8px);
      text-align:center;
      min-width:320px;
      user-select:none;
    }
    .pop.good{background:rgba(57,217,138,.20)}
    .pop.bad{background:rgba(255,92,122,.18)}
    .pop .why{display:block; margin-top:6px; font-size:12px; color:var(--muted); font-weight:750}

    /* Commit buttons (only visible inside commit zone) */
    .commitWrap{
      position:absolute;
      left:12px; right:12px; bottom:12px;
      display:none;
      gap:10px;
      z-index:6;
    }
    .commitBtn{
      flex:1;
      border-radius:16px;
      padding:14px 10px;
      border:1px solid rgba(255,255,255,.16);
      background:rgba(255,255,255,.10);
      box-shadow:var(--shadow);
      font-weight:950;
      color:var(--ink);
      cursor:pointer;
      user-select:none;
    }
    .commitBtn:active{transform:translateY(1px)}
    .commitBtn.A{border-color:rgba(124,92,255,.55)}
    .commitBtn.B{border-color:rgba(51,214,255,.55)}
    .commitBtn.C{border-color:rgba(255,122,217,.55)}

    .overlay{
      position:fixed; inset:0;
      display:none;
      background:rgba(0,0,0,.55);
      backdrop-filter: blur(6px);
      align-items:center; justify-content:center;
      padding:16px;
      z-index:50;
    }
    .modal{
      width:min(860px, 96vw);
      background:linear-gradient(180deg, rgba(255,255,255,.10), rgba(255,255,255,.06));
      border:1px solid rgba(255,255,255,.14);
      border-radius:22px;
      box-shadow:0 20px 60px rgba(0,0,0,.55);
      padding:14px;
    }
    .modal h2{margin:6px 0 8px}
    .modal p, .modal li{color:var(--muted)}
    .modal .row{display:flex; gap:10px; flex-wrap:wrap; justify-content:flex-end; margin-top:12px;}

    @media (max-width: 900px){
      .row{flex-direction:column}
      canvas{height:min(52dvh, 480px);}
      .qText{font-size:15px}
      .commitWrap{flex-direction:column}
    }
  </style>
</head>
<body>
<div class="wrap">
  <header>
    <div class="brand">
      <div class="t">GBL Runner — Commit Zone Logic (Stable Selection)</div>
      <div class="s">Read → Navigate → Enter Commit Zone → Explicitly select A/B/C (no physics-based selection)</div>
    </div>
    <div class="hud">
      <div class="pill">Score: <b id="score">0</b></div>
      <div class="pill">Accuracy: <b id="acc">0%</b></div>
      <div class="pill">Q: <b id="qnum">0</b>/<span id="qtotal">0</span></div>
      <button class="btn" id="howBtn">How to Play</button>
      <button class="btn" id="restartBtn">Restart</button>
    </div>
  </header>

  <main>
    <div class="row">
      <section class="card qCard" aria-live="polite">
        <div class="qTitle">
          <div class="badge" id="topicBadge">Ready</div>
          <div class="tiny muted">Selection happens only in the Commit Zone. Use buttons or keys (1/2/3 or A/B/C).</div>
        </div>
        <div class="qText" id="qText">Press Start to begin.</div>
        <div class="choices" id="choices"></div>

        <div class="readBarWrap" id="readWrap">
          <div class="readLabel">
            <span>Reading time…</span>
            <span id="readSecs">0.0s</span>
          </div>
          <div class="bar"><div id="readBar"></div></div>
        </div>

        <div class="statusLine" id="statusLine"></div>

        <div class="commitWrap" id="commitWrap">
          <button class="commitBtn A" id="pickA">Select A</button>
          <button class="commitBtn B" id="pickB">Select B</button>
          <button class="commitBtn C" id="pickC">Select C</button>
        </div>

        <div class="pop" id="popup"></div>
      </section>

      <section class="card gameCard">
        <canvas id="c"></canvas>

        <div class="controls">
          <div class="ctl" id="leftBtn" role="button" tabindex="0">◀ Move <small>← / A</small></div>
          <div class="ctl" id="jumpBtn" role="button" tabindex="0">⤒ Jump <small>Space / ↑</small></div>
          <div class="ctl" id="rightBtn" role="button" tabindex="0">Move ▶ <small>→ / D</small></div>
        </div>

        <div class="footerRow">
          <div class="tiny">Tip: options are markers only. Enter the yellow Commit Zone, then choose A/B/C.</div>
          <button class="btn" id="startBtn">Start</button>
        </div>
      </section>
    </div>
  </main>
</div>

<div class="overlay" id="overlay">
  <div class="modal">
    <h2 id="modalTitle">How to Play</h2>
    <div id="modalBody">
      <ul>
        <li>When a question appears, the game <b>auto-pauses</b> for a few seconds so you can read.</li>
        <li>Then the runner moves slowly. You will see option markers A/B/C ahead.</li>
        <li>After the markers, you will see a <b>yellow Commit Zone</b>.</li>
        <li>Enter the Commit Zone and <b>explicitly select</b> A/B/C using buttons (mobile) or keys (<b>1/2/3</b> or <b>A/B/C</b>).</li>
        <li>Correct = <b>+10</b>. Wrong = <b>0</b>. One attempt per question.</li>
      </ul>
      <p class="muted">This design avoids accidental answers caused by jumping/landing physics.</p>
    </div>
    <div class="row">
      <button class="btn" id="closeModal">Close</button>
    </div>
  </div>
</div>

<script>
/* =========================================================
   QUESTIONS
   Replace QUESTION_BANK with questions from your chapters.
   IMPORTANT: Write the correct answer as "correctText"
   (not fixed A/B/C), so we can shuffle options fairly.
   ========================================================= */
const QUESTION_BANK = [
  {
    id:"Q1", topic:"Mobile Security",
    q:"Safest place to install apps is:",
    options:["Official app stores","Random APK sites","Unknown message links"],
    correctText:"Official app stores",
    why:"Official stores reduce (not remove) malware risk."
  },
  {
    id:"Q2", topic:"Android",
    q:"Why enable SIM lock?",
    options:["PIN needed after restart","Faster internet","Auto updates"],
    correctText:"PIN needed after restart",
    why:"SIM lock blocks SIM use without the PIN after reboot."
  },
  {
    id:"Q3", topic:"Permissions",
    q:"If an app asks unnecessary permissions:",
    options:["Decline/uninstall","Always accept","Turn off screen lock"],
    correctText:"Decline/uninstall",
    why:"Unnecessary permissions can indicate data harvesting."
  },
  {
    id:"Q4", topic:"Messaging",
    q:"SMS messages are generally:",
    options:["Unencrypted","End-to-end encrypted","Encrypted by passcode"],
    correctText:"Unencrypted",
    why:"SMS can be vulnerable to interception."
  },
  {
    id:"Q5", topic:"iOS",
    q:"iOS data protection is strongest with a:",
    options:["Passcode","Wallpaper","Ringtone"],
    correctText:"Passcode",
    why:"Passcode enables iOS data protection features."
  },
  {
    id:"Q6", topic:"Secure chat",
    q:"An encrypted messaging app is:",
    options:["Signal","Any SMS app","Caller ID hide"],
    correctText:"Signal",
    why:"Signal supports encrypted messages and calls."
  },
];

/* =========================================================
   Utilities
   ========================================================= */
function shuffle(arr){
  const a = arr.slice();
  for(let i=a.length-1;i>0;i--){
    const j = Math.floor(Math.random()*(i+1));
    [a[i],a[j]]=[a[j],a[i]];
  }
  return a;
}
function escapeHtml(s){
  return String(s).replace(/[&<>"']/g, m => ({
    "&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#39;"
  }[m]));
}
function clamp(v,a,b){ return Math.max(a, Math.min(b, v)); }
function css(name){ return getComputedStyle(document.documentElement).getPropertyValue(name).trim(); }

/* =========================================================
   UI refs
   ========================================================= */
const scoreEl = document.getElementById("score");
const accEl   = document.getElementById("acc");
const qnumEl  = document.getElementById("qnum");
const qtotalEl= document.getElementById("qtotal");
const qTextEl = document.getElementById("qText");
const choicesEl = document.getElementById("choices");
const topicBadge = document.getElementById("topicBadge");
const popupEl = document.getElementById("popup");

const readWrap = document.getElementById("readWrap");
const readBar  = document.getElementById("readBar");
const readSecs = document.getElementById("readSecs");

const statusLine = document.getElementById("statusLine");

const commitWrap = document.getElementById("commitWrap");
const pickA = document.getElementById("pickA");
const pickB = document.getElementById("pickB");
const pickC = document.getElementById("pickC");

const overlay = document.getElementById("overlay");
const modalTitle = document.getElementById("modalTitle");
const modalBody  = document.getElementById("modalBody");

document.getElementById("howBtn").onclick = ()=> overlay.style.display="flex";
document.getElementById("closeModal").onclick = ()=> overlay.style.display="none";

/* =========================================================
   Canvas
   ========================================================= */
const canvas = document.getElementById("c");
const ctx = canvas.getContext("2d");

function fitCanvas(){
  const rect = canvas.getBoundingClientRect();
  const dpr = Math.max(1, Math.min(2, window.devicePixelRatio || 1));
  canvas.width = Math.floor(rect.width * dpr);
  canvas.height = Math.floor(rect.height * dpr);
  ctx.setTransform(dpr,0,0,dpr,0,0);
}
window.addEventListener("resize", ()=>{ fitCanvas(); initSky(); resetPlayer(); });

/* =========================================================
   Tuning (Commit Zone Strategy)
   ========================================================= */
const READ_PAUSE_MS = 4500;       // guaranteed reading time
const RUN_SPEED = 1.65;           // slow, comfortable
const GRAVITY = 0.85;
const JUMP_VEL = -14.0;
const AIR_CONTROL = 0.20;
const GROUND_CONTROL = 0.45;

const QUESTION_TIMEOUT_MS = 17000; // overall question timeout (after read phase ends)
const COMMIT_TIMEOUT_MS = 9000;    // once inside commit zone, time to select
const FEEDBACK_MS = 950;

const QUESTIONS_PER_RUN = 6;

/* World layout for each question */
const MARKER_SPREAD = 170;        // distance between A/B/C markers
const MARKER_W = 64, MARKER_H = 38;
const ZONE_W = 220;               // commit zone width
const ZONE_GAP_AFTER_MARKERS = 170; // distance after last marker to commit zone
const SAFE_LEAD_IN = 0.78;        // how far ahead to spawn sequence (relative to canvas width)

/* =========================================================
   Responsive world
   ========================================================= */
function getWorldMetrics(){
  const rect = canvas.getBoundingClientRect();
  const W = rect.width;
  const H = rect.height;

  const groundThickness = clamp(Math.round(H*0.12), 46, 72);
  const groundY = H - groundThickness;

  const playerH = clamp(Math.round(H*0.12), 56, 86);
  const playerW = Math.round(playerH*0.72);

  return {W,H,groundY,groundThickness,playerW,playerH};
}

/* =========================================================
   Sky decor
   ========================================================= */
let stars=[];
function initSky(){
  const {W,H} = getWorldMetrics();
  stars=[];
  for(let i=0;i<90;i++){
    stars.push({x:Math.random()*W, y:Math.random()*H*0.70, r:0.8+Math.random()*1.6, tw:Math.random()*6.28});
  }
}

/* =========================================================
   State
   ========================================================= */
const state = {
  running:false,
  phase:"menu", // menu | read | navigate | commit | feedback | end
  score:0,
  correct:0,
  attempted:0,

  questions:[],        // prepared questions with balanced A/B/C distribution
  qIndex:0,
  current:null,

  cameraX:0,
  worldX:0,

  // timings
  readStart:0,
  readUntil:0,
  decisionStart:0,      // time when read ends (start timing)
  questionTimeoutAt:0,  // absolute time when question expires

  // sequence elements in world space
  markers:[],           // 3 markers A/B/C (non-interactive)
  commitZone:null,      // commit zone rectangle

  // commit
  inCommitZone:false,
  commitUnlockAt:0,     // moment we entered commit zone
  committed:false,

  // fx
  floatPop:[],
  particles:[],

  // logging
  log:[]
};

function updateHUD(){
  scoreEl.textContent = String(state.score);
  const acc = state.attempted ? Math.round((state.correct/state.attempted)*100) : 0;
  accEl.textContent = acc + "%";
  qnumEl.textContent = String(state.attempted);
  qtotalEl.textContent = String(state.questions.length);
}

/* =========================================================
   Player
   ========================================================= */
const player = {
  x:120, y:0,
  w:44, h:64,
  vx:0, vy:0,
  onGround:false,
  t:0
};

function resetPlayer(){
  const m = getWorldMetrics();
  player.w = m.playerW;
  player.h = m.playerH;
  player.x = Math.round(m.W*0.25);
  player.y = m.groundY - player.h;
  player.vx = 0;
  player.vy = 0;
  player.onGround = true;
  player.t = 0;
  state.worldX = 0;
  state.cameraX = 0;
}

/* =========================================================
   Input
   ========================================================= */
const input = {left:false, right:false, jump:false};

window.addEventListener("keydown",(e)=>{
  const k=e.code;
  if(["ArrowLeft","ArrowRight","ArrowUp","Space","KeyA","KeyD","Digit1","Digit2","Digit3","KeyB","KeyC","Enter"].includes(k)) e.preventDefault();

  // movement
  if(k==="ArrowLeft"||k==="KeyA") input.left=true;
  if(k==="ArrowRight"||k==="KeyD") input.right=true;
  if(k==="ArrowUp"||k==="Space") input.jump=true;

  // commit selection keys (only active in commit phase)
  if(state.phase === "commit" && state.inCommitZone && !state.committed){
    if(k==="Digit1" || k==="KeyA") commitAnswer("A");
    if(k==="Digit2" || k==="KeyB") commitAnswer("B");
    if(k==="Digit3" || k==="KeyC") commitAnswer("C");
  }
});
window.addEventListener("keyup",(e)=>{
  const k=e.code;
  if(k==="ArrowLeft"||k==="KeyA") input.left=false;
  if(k==="ArrowRight"||k==="KeyD") input.right=false;
});

function bindHold(btn, onDown, onUp){
  btn.addEventListener("pointerdown",(e)=>{ e.preventDefault(); onDown(); });
  btn.addEventListener("pointerup",(e)=>{ e.preventDefault(); onUp(); });
  btn.addEventListener("pointercancel",(e)=>{ e.preventDefault(); onUp(); });
}
bindHold(document.getElementById("leftBtn"), ()=>input.left=true, ()=>input.left=false);
bindHold(document.getElementById("rightBtn"),()=>input.right=true,()=>input.right=false);
document.getElementById("jumpBtn").addEventListener("pointerdown",(e)=>{ e.preventDefault(); input.jump=true; });

// commit buttons
pickA.onclick = ()=> commitAnswer("A");
pickB.onclick = ()=> commitAnswer("B");
pickC.onclick = ()=> commitAnswer("C");

/* =========================================================
   Question preparation: shuffle options + balance correct letters
   ========================================================= */
function prepareQuestionsBalanced(){
  // sample questions
  const selected = shuffle(QUESTION_BANK).slice(0, Math.min(QUESTIONS_PER_RUN, QUESTION_BANK.length));

  // target distribution A/B/C close to equal
  const n = selected.length;
  const targets = {A:0, B:0, C:0};
  // simple equal split, remainder assigned randomly
  const base = Math.floor(n/3);
  targets.A = base; targets.B = base; targets.C = base;
  let rem = n - 3*base;
  const letters = shuffle(["A","B","C"]);
  for(let i=0;i<rem;i++) targets[letters[i]]++;

  const used = {A:0, B:0, C:0};

  const prepared = selected.map((qObj, idx) => {
    const opts = qObj.options.slice();
    // shuffle options a few times until we can assign desired correct letter
    let best = null;

    for(let tries=0; tries<50; tries++){
      const sh = shuffle(opts);

      // map to A/B/C
      const map = {A:sh[0], B:sh[1], C:sh[2]};

      // compute correct letter
      const correctLetter = (map.A === qObj.correctText) ? "A"
                           : (map.B === qObj.correctText) ? "B"
                           : "C";

      // choose if we still need this letter according to targets
      if(used[correctLetter] < targets[correctLetter]){
        best = {map, correctLetter, shown: sh};
        break;
      }
      // otherwise keep a fallback
      if(!best) best = {map, correctLetter, shown: sh};
    }

    used[best.correctLetter]++;

    return {
      id: qObj.id,
      topic: qObj.topic,
      q: qObj.q,
      A: best.map.A,
      B: best.map.B,
      C: best.map.C,
      correct: best.correctLetter,
      correctText: qObj.correctText,
      why: qObj.why
    };
  });

  return prepared;
}

/* =========================================================
   Question UI
   ========================================================= */
function renderQuestion(q){
  state.current = q;
  topicBadge.textContent = q.topic;
  qTextEl.textContent = q.q;
  choicesEl.innerHTML = `
    <div class="choice"><div class="tag A">A</div><div><b>${escapeHtml(q.A)}</b></div></div>
    <div class="choice"><div class="tag B">B</div><div><b>${escapeHtml(q.B)}</b></div></div>
    <div class="choice"><div class="tag C">C</div><div><b>${escapeHtml(q.C)}</b></div></div>
  `;
}

function showPopup(ok, correctKey, why){
  popupEl.className = "pop " + (ok ? "good" : "bad");
  popupEl.style.display = "block";
  popupEl.innerHTML = (ok ? "✅ Correct! (+10)" : "❌ Wrong!") +
    `<span class="why">Correct: ${correctKey}. ${escapeHtml(why)}</span>`;
  setTimeout(()=> popupEl.style.display="none", FEEDBACK_MS);
}

function setStatus(text, show=true){
  statusLine.textContent = text;
  statusLine.style.display = show ? "block" : "none";
}

/* =========================================================
   World sequence for each question
   Markers (A/B/C) are visual only.
   Commit Zone is neutral gate used to unlock selection.
   ========================================================= */
function buildSequenceForQuestion(){
  const m = getWorldMetrics();
  const baseX = state.worldX + Math.round(m.W * SAFE_LEAD_IN);

  const y = m.groundY - MARKER_H;

  state.markers = [
    {key:"A", x: baseX + 0*MARKER_SPREAD, y, w:MARKER_W, h:MARKER_H},
    {key:"B", x: baseX + 1*MARKER_SPREAD, y, w:MARKER_W, h:MARKER_H},
    {key:"C", x: baseX + 2*MARKER_SPREAD, y, w:MARKER_W, h:MARKER_H},
  ];

  const last = state.markers[state.markers.length-1];
  const zoneX = last.x + last.w + ZONE_GAP_AFTER_MARKERS;
  const zoneY = m.groundY - 64;

  state.commitZone = {
    x: zoneX,
    y: zoneY,
    w: ZONE_W,
    h: 64
  };
}

/* =========================================================
   Commit Zone handling
   ========================================================= */
function playerWorldRect(){
  const pwx = state.worldX + player.x;
  return {x:pwx, y:player.y, w:player.w, h:player.h};
}
function rectOverlap(a,b){
  return a.x < b.x+b.w && a.x+a.w > b.x && a.y < b.y+b.h && a.y+a.h > b.y;
}

function updateCommitZone(now){
  if(state.phase !== "navigate" && state.phase !== "commit") return;
  if(!state.commitZone) return;

  const pr = playerWorldRect();
  const inZone = rectOverlap(pr, state.commitZone);

  if(inZone && !state.inCommitZone){
    state.inCommitZone = true;
    state.phase = "commit";
    state.commitUnlockAt = now;
    commitWrap.style.display = "flex";
    setStatus("You are in the COMMIT ZONE. Select A/B/C now (keys 1/2/3 or A/B/C).", true);

    // auto-timeout inside commit zone
    setTimeout(()=>{
      if(state.phase === "commit" && state.inCommitZone && !state.committed){
        noAnswer("No selection in Commit Zone.");
      }
    }, COMMIT_TIMEOUT_MS);
  }

  // if learner leaves commit zone without committing, keep them in commit phase but hide buttons
  // (They must re-enter zone to select.)
  if(!inZone && state.inCommitZone && !state.committed){
    state.inCommitZone = false;
    commitWrap.style.display = "none";
    setStatus("Move back into the yellow COMMIT ZONE to select A/B/C.", true);
  }

  // if committed, hide UI
  if(state.committed){
    commitWrap.style.display = "none";
  }
}

function commitAnswer(letter){
  if(state.phase !== "commit") return;
  if(!state.inCommitZone) return;
  if(state.committed) return;

  state.committed = true;

  const q = state.current;
  const ok = (letter === q.correct);

  state.attempted++;
  if(ok){
    state.correct++;
    state.score += 10;
    addFloatPop(state.worldX + player.x + player.w/2, player.y - 14, "+10", "rgba(57,217,138,.95)", 700);
    addBurst(state.worldX + player.x + player.w/2, player.y + 10, "rgba(57,217,138,.95)");
  }else{
    addFloatPop(state.worldX + player.x + player.w/2, player.y - 14, "0", "rgba(255,255,255,.85)", 650);
    addBurst(state.worldX + player.x + player.w/2, player.y + 10, "rgba(255,92,122,.95)");
  }

  // response time measured from end of read phase
  const rt = Math.max(0, Math.round(performance.now() - state.decisionStart));

  state.log.push({
    ts: new Date().toISOString(),
    qid: q.id,
    topic: q.topic,
    option_order: `A:${q.A} | B:${q.B} | C:${q.C}`,
    selected: letter,
    correct: q.correct,
    is_correct: ok ? 1 : 0,
    response_ms: rt,
    score_after: state.score
  });

  updateHUD();
  showPopup(ok, q.correct, q.why);

  setStatus("Feedback shown. Next question loading…", true);

  state.phase = "feedback";
  setTimeout(()=> nextQuestion(), FEEDBACK_MS);
}

function noAnswer(reason){
  if(state.phase === "feedback") return;
  if(state.committed) return;

  state.committed = true; // lock
  state.attempted++;
  updateHUD();

  const q = state.current;
  const rt = Math.max(0, Math.round(performance.now() - state.decisionStart));

  state.log.push({
    ts: new Date().toISOString(),
    qid: q.id,
    topic: q.topic,
    option_order: `A:${q.A} | B:${q.B} | C:${q.C}`,
    selected: "NA",
    correct: q.correct,
    is_correct: 0,
    response_ms: rt,
    score_after: state.score
  });

  showPopup(false, q.correct, reason || "No answer recorded.");
  setStatus("No answer. Next question loading…", true);

  state.phase = "feedback";
  setTimeout(()=> nextQuestion(), FEEDBACK_MS);
}

/* =========================================================
   VFX
   ========================================================= */
function addFloatPop(worldX, y, text, color, ms=650){
  state.floatPop.push({x:worldX, y, text, color, until: performance.now()+ms});
}
function addBurst(worldX, y, color){
  for(let i=0;i<14;i++){
    const ang = Math.random()*Math.PI*2;
    const sp = 1.5 + Math.random()*2.6;
    state.particles.push({
      x:worldX, y,
      vx: Math.cos(ang)*sp,
      vy: Math.sin(ang)*sp - 1.2,
      born: performance.now(),
      life: 520 + Math.random()*260,
      color,
      r: 1.6 + Math.random()*2.4
    });
  }
}

/* =========================================================
   Drawing helpers
   ========================================================= */
function roundRect(x,y,w,h,r){
  ctx.beginPath();
  ctx.moveTo(x+r,y);
  ctx.arcTo(x+w,y,x+w,y+h,r);
  ctx.arcTo(x+w,y+h,x,y+h,r);
  ctx.arcTo(x,y+h,x,y,r);
  ctx.arcTo(x,y,x+w,y,r);
  ctx.closePath();
}

function drawSky(now, W, H){
  for(const s of stars){
    const tw = 0.45 + 0.55*Math.sin(now/700 + s.tw);
    ctx.globalAlpha = 0.25 + tw*0.65;
    ctx.fillStyle = "rgba(255,255,255,.95)";
    ctx.beginPath();
    ctx.arc(s.x, s.y, s.r, 0, Math.PI*2);
    ctx.fill();
  }
  ctx.globalAlpha = 1;

  ctx.globalAlpha = 0.18;
  ctx.fillStyle = "rgba(100,181,255,.9)";
  ctx.beginPath();
  ctx.ellipse(W*0.15, H*0.95, W*0.55, H*0.55, 0, 0, Math.PI*2);
  ctx.fill();
  ctx.beginPath();
  ctx.ellipse(W*0.92, H*1.02, W*0.55, H*0.45, 0, 0, Math.PI*2);
  ctx.fill();
  ctx.globalAlpha = 1;

  const g = ctx.createLinearGradient(0,0,0,H);
  g.addColorStop(0,"rgba(255,255,255,.06)");
  g.addColorStop(0.55,"rgba(255,255,255,.00)");
  ctx.fillStyle=g;
  ctx.fillRect(0,0,W,H);
}

function drawGround(W, groundY, thick){
  const base = ctx.createLinearGradient(0, groundY, 0, groundY+thick);
  base.addColorStop(0, "rgba(46,101,196,.92)");
  base.addColorStop(1, "rgba(20,35,74,.92)");
  ctx.fillStyle = base;
  roundRect(0, groundY, W, thick, 16);
  ctx.fill();

  ctx.globalAlpha = 0.12;
  ctx.fillStyle = "white";
  for(let x=16; x<W; x+=34){
    ctx.fillRect(x, groundY+18, 14, 10);
  }
  ctx.globalAlpha = 1;
}

function drawPlayer(now){
  player.t += 0.12 + Math.min(0.20, Math.abs(player.vx)*0.08);
  const x = player.x, y = player.y, w = player.w, h = player.h;

  // shadow
  ctx.fillStyle="rgba(0,0,0,.30)";
  ctx.beginPath();
  ctx.ellipse(x+w*0.5, y+h+10, w*0.42, 6, 0, 0, Math.PI*2);
  ctx.fill();

  // helmet
  const headR = Math.max(14, w*0.45);
  const hx = x + w*0.5;
  const hy = y + h*0.28;

  const headGrad = ctx.createLinearGradient(hx-headR, hy-headR, hx+headR, hy+headR);
  headGrad.addColorStop(0,"rgba(255,255,255,.98)");
  headGrad.addColorStop(1,"rgba(170,210,255,.85)");
  ctx.fillStyle = headGrad;
  ctx.beginPath();
  ctx.arc(hx, hy, headR, 0, Math.PI*2);
  ctx.fill();

  // visor
  const vg = ctx.createLinearGradient(hx-headR*0.6, hy-headR*0.2, hx+headR*0.6, hy+headR*0.4);
  vg.addColorStop(0,"rgba(51,214,255,.70)");
  vg.addColorStop(1,"rgba(124,92,255,.55)");
  ctx.fillStyle = vg;
  roundRect(hx-headR*0.62, hy-headR*0.18, headR*1.24, headR*0.56, 10);
  ctx.fill();

  // torso
  const bodyTop = y + h*0.42;
  const bodyH = h*0.52;
  const bodyGrad = ctx.createLinearGradient(x, bodyTop, x, bodyTop+bodyH);
  bodyGrad.addColorStop(0,"rgba(235,245,255,.95)");
  bodyGrad.addColorStop(1,"rgba(150,195,255,.80)");
  ctx.fillStyle = bodyGrad;
  roundRect(x+w*0.10, bodyTop, w*0.80, bodyH, 16);
  ctx.fill();

  // belt
  ctx.globalAlpha = 0.55;
  ctx.fillStyle="rgba(7,16,37,.92)";
  roundRect(x+w*0.18, bodyTop+bodyH*0.45, w*0.64, 8, 6);
  ctx.fill();
  ctx.globalAlpha = 1;

  // arms & legs
  const armSwing = Math.sin(player.t)*6;
  ctx.strokeStyle="rgba(255,255,255,.85)";
  ctx.lineWidth = Math.max(5, w*0.14);
  ctx.lineCap="round";
  ctx.beginPath();
  ctx.moveTo(x+w*0.18, bodyTop+bodyH*0.22);
  ctx.lineTo(x+w*0.10, bodyTop+bodyH*0.40 + armSwing*0.10);
  ctx.stroke();
  ctx.beginPath();
  ctx.moveTo(x+w*0.82, bodyTop+bodyH*0.22);
  ctx.lineTo(x+w*0.90, bodyTop+bodyH*0.40 - armSwing*0.10);
  ctx.stroke();

  const step = Math.sin(player.t)*7;
  ctx.strokeStyle="rgba(255,255,255,.90)";
  ctx.lineWidth = Math.max(6, w*0.16);
  ctx.beginPath();
  ctx.moveTo(x+w*0.36, y+h-6);
  ctx.lineTo(x+w*0.36 + step*0.45, y+h+10);
  ctx.stroke();
  ctx.beginPath();
  ctx.moveTo(x+w*0.64, y+h-6);
  ctx.lineTo(x+w*0.64 - step*0.45, y+h+10);
  ctx.stroke();

  // outline
  ctx.strokeStyle="rgba(100,181,255,.55)";
  ctx.lineWidth=2;
  ctx.beginPath();
  ctx.arc(hx, hy, headR, 0, Math.PI*2);
  ctx.stroke();
  roundRect(x+w*0.10, bodyTop, w*0.80, bodyH, 16);
  ctx.stroke();
}

function drawMarkers(){
  const cam = state.cameraX;

  for(const mk of state.markers){
    const sx = mk.x - cam;
    const sy = mk.y;

    // identical look for all markers (no hint)
    ctx.globalAlpha = 0.18;
    ctx.fillStyle = "rgba(255,255,255,.45)";
    roundRect(sx-6, sy-6, mk.w+12, mk.h+12, 14);
    ctx.fill();
    ctx.globalAlpha = 1;

    const grad = ctx.createLinearGradient(sx,sy,sx,sy+mk.h);
    grad.addColorStop(0, "rgba(255,255,255,.16)");
    grad.addColorStop(1, "rgba(0,0,0,.18)");
    ctx.fillStyle = grad;
    roundRect(sx, sy, mk.w, mk.h, 12);
    ctx.fill();

    ctx.globalAlpha = 0.55;
    ctx.strokeStyle = "rgba(255,255,255,.55)";
    ctx.lineWidth = 2;
    roundRect(sx+3, sy+3, mk.w-6, mk.h-6, 10);
    ctx.stroke();
    ctx.globalAlpha = 1;

    // label
    ctx.fillStyle = "rgba(234,240,255,.95)";
    ctx.font = "950 18px system-ui,Segoe UI,Arial";
    ctx.fillText(mk.key, sx + mk.w/2 - 6, sy + mk.h/2 + 6);
  }
}

function drawCommitZone(now){
  if(!state.commitZone) return;
  const cam = state.cameraX;
  const z = state.commitZone;
  const sx = z.x - cam, sy = z.y;

  // pulsing glow
  const pulse = 0.35 + 0.25*Math.sin(now/220);
  ctx.globalAlpha = pulse;
  ctx.fillStyle = "rgba(255,216,77,.55)";
  roundRect(sx-8, sy-8, z.w+16, z.h+16, 16);
  ctx.fill();
  ctx.globalAlpha = 1;

  // zone body
  const g = ctx.createLinearGradient(sx,sy,sx,sy+z.h);
  g.addColorStop(0, "rgba(255,216,77,.38)");
  g.addColorStop(1, "rgba(0,0,0,.14)");
  ctx.fillStyle = g;
  roundRect(sx, sy, z.w, z.h, 14);
  ctx.fill();

  ctx.strokeStyle = "rgba(255,216,77,.90)";
  ctx.lineWidth = 2;
  ctx.setLineDash([6,6]);
  roundRect(sx+2, sy+2, z.w-4, z.h-4, 12);
  ctx.stroke();
  ctx.setLineDash([]);

  ctx.fillStyle = "rgba(7,16,37,.92)";
  ctx.font = "950 12px system-ui,Segoe UI,Arial";
  ctx.fillText("COMMIT ZONE", sx + 14, sy + z.h/2 + 4);
}

function drawFloatPops(now){
  state.floatPop = state.floatPop.filter(p => now < p.until);
  for(const p of state.floatPop){
    const t = 1 - ((p.until - now)/650);
    const sx = (p.x - state.cameraX);
    ctx.globalAlpha = 1 - t;
    ctx.fillStyle = p.color;
    ctx.font = "900 14px system-ui,Segoe UI,Arial";
    ctx.fillText(p.text, sx, p.y - t*18);
    ctx.globalAlpha = 1;
  }
}

function drawParticles(now){
  state.particles = state.particles.filter(pt => (now - pt.born) < pt.life);
  for(const pt of state.particles){
    const age = now - pt.born;
    const t = age / pt.life;
    pt.x += pt.vx;
    pt.y += pt.vy;
    pt.vy += 0.06;

    const sx = pt.x - state.cameraX;
    ctx.globalAlpha = 1 - t;
    ctx.fillStyle = pt.color;
    ctx.beginPath();
    ctx.arc(sx, pt.y, pt.r, 0, Math.PI*2);
    ctx.fill();
    ctx.globalAlpha = 1;
  }
}

function drawHint(now, W, H){
  ctx.fillStyle = "rgba(255,255,255,.08)";
  ctx.fillRect(0, H-40, W, 40);
  ctx.fillStyle = "rgba(234,240,255,.92)";
  ctx.font = "900 12px system-ui,Segoe UI,Arial";

  if(state.phase === "read"){
    ctx.fillText("Reading time… (movement disabled)", 12, H-16);
  }else if(state.phase === "navigate"){
    ctx.fillText("Navigate to the yellow COMMIT ZONE to select A/B/C.", 12, H-16);
  }else if(state.phase === "commit"){
    ctx.fillText("You are in COMMIT ZONE. Choose A/B/C now (buttons or 1/2/3).", 12, H-16);
  }else{
    ctx.fillText("Runner is for engagement. Selection is explicit in Commit Zone.", 12, H-16);
  }
}

function draw(now){
  const m = getWorldMetrics();
  const W = m.W, H = m.H;

  ctx.clearRect(0,0,W,H);
  drawSky(now, W, H);
  drawGround(W, m.groundY, m.groundThickness);

  drawMarkers();
  drawCommitZone(now);
  drawParticles(now);
  drawFloatPops(now);
  drawPlayer(now);
  drawHint(now, W, H);
}

/* =========================================================
   Step (physics + phases)
   ========================================================= */
function step(now){
  if(!state.running) return;

  const m = getWorldMetrics();
  const groundY = m.groundY;

  // read bar progress
  if(state.phase === "read"){
    const total = state.readUntil - state.readStart;
    const done = clamp(now - state.readStart, 0, total);
    const pct = total > 0 ? (done/total)*100 : 100;
    readBar.style.width = pct.toFixed(1) + "%";
    readSecs.textContent = Math.max(0, (total - done)/1000).toFixed(1) + "s";

    // end read phase
    if(now >= state.readUntil){
      readWrap.style.display = "none";
      state.phase = "navigate";
      state.decisionStart = performance.now();
      state.questionTimeoutAt = state.decisionStart + QUESTION_TIMEOUT_MS;
      setStatus("Navigate forward to the yellow COMMIT ZONE. Options shown are A/B/C.", true);
    }
  }

  // question overall timeout (after read ends)
  if((state.phase === "navigate" || state.phase === "commit") && !state.committed){
    if(performance.now() >= state.questionTimeoutAt){
      noAnswer("Time expired.");
    }
  }

  const inReadPause = (state.phase === "read" || state.phase === "feedback" || state.phase === "end");
  const forward = (!inReadPause && (state.phase === "navigate" || state.phase === "commit")) ? RUN_SPEED : 0;
  state.worldX += forward;

  // lateral control (disabled during read to avoid distraction)
  const ctl = player.onGround ? GROUND_CONTROL : AIR_CONTROL;
  if(!inReadPause){
    if(input.left)  player.vx -= ctl;
    if(input.right) player.vx += ctl;
  }
  player.vx *= 0.88;
  player.vx = clamp(player.vx, -3.0, 3.0);

  // jump (disabled during read/feedback)
  if(input.jump){
    input.jump = false;
    if(!inReadPause && player.onGround){
      player.vy = JUMP_VEL;
      player.onGround = false;
      addBurst(state.worldX + player.x + player.w/2, player.y + player.h, "rgba(255,255,255,.75)");
    }
  }

  // gravity
  player.vy += GRAVITY;
  player.vy = Math.min(player.vy, 18);

  // integrate
  player.x += player.vx;
  player.y += player.vy;

  // keep player visible (screen-space)
  player.x = clamp(player.x, 24, m.W - player.w - 24);

  // ground collision
  const floor = groundY - player.h;
  if(player.y >= floor){
    player.y = floor;
    player.vy = 0;
    player.onGround = true;
  }

  // camera
  state.cameraX = state.worldX;

  // commit zone checks
  updateCommitZone(now);
}

/* =========================================================
   Question flow
   ========================================================= */
function startQuestion(){
  if(state.qIndex >= state.questions.length){
    endGame();
    return;
  }

  // reset per-question
  state.markers = [];
  state.commitZone = null;
  state.inCommitZone = false;
  state.commitUnlockAt = 0;
  state.committed = false;
  commitWrap.style.display = "none";
  setStatus("", false);

  const q = state.questions[state.qIndex++];
  renderQuestion(q);

  // build world elements for this question
  buildSequenceForQuestion();

  // enter read phase
  state.phase = "read";
  state.readStart = performance.now();
  state.readUntil = state.readStart + READ_PAUSE_MS;

  readWrap.style.display = "block";
  readBar.style.width = "0%";
  readSecs.textContent = (READ_PAUSE_MS/1000).toFixed(1) + "s";
}

function nextQuestion(){
  popupEl.style.display="none";
  setStatus("", false);

  // small separation
  setTimeout(()=> startQuestion(), 650);
}

/* =========================================================
   End + CSV
   ========================================================= */
function downloadCSV(){
  const rows = [["ts","qid","topic","option_order","selected","correct","is_correct","response_ms","score_after"]];
  for(const r of state.log){
    rows.push([r.ts,r.qid,r.topic,r.option_order,r.selected,r.correct,r.is_correct,r.response_ms,r.score_after]);
  }
  const csv = rows.map(r => r.map(v => `"${String(v).replace(/"/g,'""')}"`).join(",")).join("\n");
  const blob = new Blob([csv], {type:"text/csv;charset=utf-8"});
  const url = URL.createObjectURL(blob);
  const a = document.createElement("a");
  a.href=url; a.download="GBL_CommitZone_Log.csv";
  document.body.appendChild(a); a.click(); a.remove();
  URL.revokeObjectURL(url);
}

function endGame(){
  state.running = false;
  state.phase = "end";
  commitWrap.style.display = "none";
  readWrap.style.display = "none";
  setStatus("", false);

  const acc = state.attempted ? Math.round((state.correct/state.attempted)*100) : 0;
  modalTitle.textContent = "Run Completed";
  modalBody.innerHTML = `
    <p><b>Score:</b> ${state.score} &nbsp; | &nbsp; <b>Accuracy:</b> ${acc}% &nbsp; | &nbsp; <b>Attempted:</b> ${state.attempted}</p>
    <p class="muted">Download CSV for analysis.</p>
    <div class="row" style="justify-content:flex-start; margin-top:10px; gap:10px;">
      <button class="btn" id="dlBtn">Download CSV</button>
    </div>
  `;
  overlay.style.display = "flex";
  setTimeout(()=> document.getElementById("dlBtn").onclick = downloadCSV, 0);
}

/* =========================================================
   Boot / Start
   ========================================================= */
function boot(){
  state.running = false;
  state.phase = "menu";

  state.score = 0;
  state.correct = 0;
  state.attempted = 0;

  state.questions = prepareQuestionsBalanced();
  state.qIndex = 0;

  state.cameraX = 0;
  state.worldX = 0;

  state.markers = [];
  state.commitZone = null;

  state.floatPop = [];
  state.particles = [];
  state.log = [];

  popupEl.style.display = "none";
  readWrap.style.display = "none";
  commitWrap.style.display = "none";
  setStatus("", false);

  topicBadge.textContent = "Ready";
  qTextEl.textContent = "Press Start to begin.";
  choicesEl.innerHTML = "";

  qtotalEl.textContent = String(state.questions.length);
  updateHUD();
  resetPlayer();
}

function startGame(){
  overlay.style.display = "none";
  state.running = true;

  topicBadge.textContent = "Starting";
  setStatus("Starting…", true);

  // short warm-up then first question
  setTimeout(()=>{
    setStatus("", false);
    startQuestion();
  }, 650);
}

/* =========================================================
   Buttons
   ========================================================= */
document.getElementById("restartBtn").onclick = ()=> { overlay.style.display="none"; boot(); };
document.getElementById("startBtn").onclick = ()=> { if(!state.running) startGame(); };

/* =========================================================
   Loop
   ========================================================= */
function loop(now){
  step(now);
  draw(now);
  requestAnimationFrame(loop);
}

/* =========================================================
   Init
   ========================================================= */
fitCanvas();
initSky();
boot();
requestAnimationFrame(loop);
</script>
</body>
</html>
```
